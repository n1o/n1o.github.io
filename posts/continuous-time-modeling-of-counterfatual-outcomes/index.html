<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Marek Barak"><meta name=description content="The problem it solves Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:
If I perform a hypothetical sequence of interventions how will my time series evolve?
An example and some details Example As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations"><meta name=twitter:description content="The problem it solves Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:
If I perform a hypothetical sequence of interventions how will my time series evolve?
An example and some details Example As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics."><meta property="og:title" content="Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations"><meta property="og:description" content="The problem it solves Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:
If I perform a hypothetical sequence of interventions how will my time series evolve?
An example and some details Example As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics."><meta property="og:type" content="article"><meta property="og:url" content="https://n1o.github.io/posts/continuous-time-modeling-of-counterfatual-outcomes/"><meta property="article:published_time" content="2023-01-16T17:37:36+01:00"><meta property="article:modified_time" content="2023-01-16T17:37:36+01:00"><title>Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations · Data, Engineering and Stuff</title><link rel=canonical href=https://n1o.github.io/posts/continuous-time-modeling-of-counterfatual-outcomes/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8/normalize.min.css><link rel=stylesheet href=/css/coder.min.f01c647a0d25b40da992a37c3376291185eed8a50ced8c26cc2c0bcfe38c97df.css integrity="sha256-8Bxkeg0ltA2pkqN8M3YpEYXu2KUM7YwmzCwLz+OMl98=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><script defer src=https://twemoji.maxcdn.com/v/13.0.1/twemoji.min.js integrity=sha384-5f4X0lBluNY/Ib4VhGx0Pf6iDCF99VGXJIyYy7dDLY5QlEd7Ap0hICSSZA1XYbc4 crossorigin=anonymous></script><meta name=generator content="Hugo 0.79.1"></head><body class=colorscheme-auto onload=twemoji.parse(document.body);><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Data, Engineering and Stuff</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2023-01-16T17:37:36+01:00>January 16, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>6-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i><a href=/tags/causality/>causality</a>
<span class=separator>•</span>
<a href=/tags/differential_equation/>differential_equation</a></div></div></header><div><h1 id=the-problem-it-solves>The problem it solves</h1><p>Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:</p><p><em>If I perform a hypothetical sequence of interventions how will my time series evolve?</em></p><h1 id=an-example-and-some-details>An example and some details</h1><h2 id=example>Example</h2><p>As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics. If the CRP level is high, antibiotics are administered at a certain dosage. However, the effects of antibiotics may not be immediate and it may take some time before they show. In this scenario, the doctor would wait for some time and measure the patient&rsquo;s CRP levels again.</p><p>There are generally 3 outcomes that can occur in this scenario:</p><ol><li><p>The CRP level decreases after antibiotics are administered, indicating that the infection is being successfully treated.</p></li><li><p>The CRP level remains unchanged or only slightly decreases, indicating that the antibiotics may not be effective for this particular infection or the dosage may not be sufficient.</p></li><li><p>The CRP level increases, indicating that the infection may be getting worse and a different course of treatment may be needed.</p></li></ol><p>It is our decision to stick with the current treatment or change it.</p><h2 id=details>Details</h2><p>We can visuallize the example above as:</p><p><img src=/images/ct_cde_medical_example.jpg alt="Medical Example"></p><p>At every time step we measure the CRP levels of a patient. The CRP levels not only influence the dosage and type of antibiotics prescribed, but they also serve as an indicator of the patient&rsquo;s likelihood of dying. Antibiotics are intended to lower the probability of death by reducing future CRP levels. This logic is intuitive, but there is a hidden catch: we have introduced time-dependent confounding. To understand this, let&rsquo;s start by defining time-dependent variables and time-dependent treatment.</p><h3 id=time-dependent-variables>Time-Dependent variables</h3><p>Are variables that change over time and they are repeatedly measured. In our case CRP levels are a time-dependent variable</p><h3 id=time-dependent-treatment>Time-Dependent treatment</h3><p>Treatment (or just action) that is a response to a change in time-dependent variable. In our case this the type and dose of antibiotics.</p><h3 id=time-dependent-confounding>Time-Dependent confounding</h3><p>It is a confounder that is affected by the previous treatment. In our case the current dose (type) of antibiotics has an influence on future doses (types) of antibiotics. For those who have an machine learning background we can say that each treatment introduces an distribution shift.</p><h1 id=counterfactuals-confounding--and-bias>Counterfactuals, confounding and bias</h1><p>At the beggining we asked the following question:</p><p><em>If I perform a hypothetical sequence of interventions how will my time series evolve?</em></p><p>We already introduced time-dependent confounding, so we know that each time we perform some sort of intervention it potentially can shift the distribution. In order to accurately determine the effect of a hypothetical sequence of interventions, it is crucial to take into account all past interventions and consider how each new intervention could potentially affect the distribution further.</p><p>If we want to have an unbiased counterfactual estimate we have to remove confounding (close all the back doors).</p><h1 id=treatment-effect-neural-controlled-differential-equation-tc-cde-model>Treatment Effect Neural Controlled Differential Equation (TC-CDE) Model</h1><p>The main idea is to use time-dependent variables and treatments to fit a neural controlled differential equation (NCDE). An NCDE is a type of differential equation where the vector field is represented by a neural network. The solution to the equation is not only determined by its initial conditions, but also by subsequent observations.</p><p>For example, in the context of inflammation, we can view inflammation as a latent process that evolves over time due to the immune system or medication. CRP levels are realizations of this latent process. Modeling this process can be difficult, but the TC-CDE model addresses this by expressing the latent process as a solution to an NCDE.</p><p>However, for counterfactual estimation, modeling the latent process as an NCDE is not sufficient. To achieve an unbiased counterfactual estimate, we need to ensure that the latent process is not predictive of the treatment that will be administered. Additionally, we need to ensure that administering a treatment at time t will not change the latent value at time t, but only influence its future latent dynamics.</p><h2 id=a-bit-of-math>A bit of Math</h2><p>I always try to avoid using equations, but I don&rsquo;t always succeed. For those who are more familiar with machine learning and haven&rsquo;t seen differential equations in a while (or ever), the strange integral can be viewed as the temporal evolution of some state. The dynamics of the evolution are governed by a differential equation.</p><h3 id=latent-path>Latent Path</h3><p>To get the latent path we first have to define the initial state:</p><p>$$Z_{t0} = g_{\eta}(X_{t0},A_{t0}, Y_{t0})$$</p><ul><li>$g_{\theta}$ is a neural network that takes the initial covariates $X_{t0}$, treatment assignment $A_{t0}$ and observed outcome $T_{t0}$ and produces the initial latent space embedding $Z_{t0}$</li></ul><p>Next we define our evolution of the initial state:</p><p>$$Z_t = S_{t0} + \int_{t_0}^t f_{\theta}(Z_s) \frac{d[S_s, A_s, Y_s]}{ds}ds $$</p><p>for $t \in (t_0, t]$</p><ul><li>$Z$ is a response that is a solution to NCDE</li><li>$f_{\theta}$ is the latent vector field parametrized by a neural network</li></ul><h3 id=objective-function>Objective function</h3><p>To mitigate confounding bias we have to make sure that the latent path is not predictive of future treatments to achieve this we introduce 2 neural networks:</p><ol><li><p>$h_v: R^l \rightarrow R^d$ used to predict the outcome $\hat{y}_s = h_v(Z_s)$</p></li><li><p>$h_a: R^l \rightarrow [0,1]$ used to predict the treatment $\hat{p}<em>s = \hat{p}(a_s = 1) = h</em>{a}(Z_s)$</p></li></ol><p>If there are k>1 observations in the timewindow $[t,t']$ with observation times $(t_1, \cdots, t_k)$ our loss function is defined as</p><p>$$L = \frac{1}{n}\sum_{i=1}^n L_i^{(y)} - \mu L_i^{(a)} $$</p><ul><li>$L^{(y)} = \frac{1}{k} (y_{t_j} - \hat{y}_{t_j})^2$ this is the sequare mean of outcome prediction</li><li>$L^{(a)} = - \frac{1}{k} \sum_{j=1}^k a_{t_j} \log(\hat{p}_{t_j}) + (1-a_j)\log (1 - \hat{p}_{t_j})$ this is the cross entropy of treatment predictions</li></ul><p>Since there is a substraction before $\mu$ we essentially maximize the cross entropy ensuring that $z_t$ is not predictive of the treatment assignment $A_t$. This leads to balancing representations removing bias form time-dependent confounders allowing reliable counterfactual estimation where $\mu$ controlls the tradeoff between treatment and outcome predictions.</p><h3 id=hypothetical-path>Hypothetical path</h3><p>Our initial goal was to evaluate the effect of some hypothetical treatment schedule. Because of this we need to go from $t$ to some future $t'$:</p><p>$$Z_{t'} = Z_t = \int_{t}^{t'}f_{\theta}(Z_s)\frac{dA_s}{ds}ds $$</p><ul><li>$Z_t$ is the encoded latent state of a patient up to time t</li><li>$A_s$ is the hypothetical treatment schedule $t &lt; s &lt; t'$</li></ul><p>To get the predicted outcome we use our neural network trained before</p><p>$$\hat{y}<em>{t'} = h_v(Z</em>{t'})$$</p><h1 id=summary>Summary</h1><p>Being able to generate unbiased estimates of some outcome value given hypothetical treatment schedules (or just some sort of actions) is a powerful tool. And not requiring an fixed schedule for these actions makes it also very versatile. And I look forward for extensions on these method.</p><h1 id=disclaimer>Disclaimer</h1><p>I did read the original paper, and look at the code that was supplied with it. I did write this article on my own, however since I am not a native speaker, I did use ChatGPT for proof reading and improving my writing. If you are really interested how the original was worded. I will provide a link below.</p><h1 id=sources>Sources</h1><ol><li><a href=https://github.com/seedatnabeel/TE-CDE>https://github.com/seedatnabeel/TE-CDE</a></li><li><a href=https://arxiv.org/abs/2206.08311>https://arxiv.org/abs/2206.08311</a></li><li>Pre ChatGPT: <a href=https://github.com/n1o/n1o.github.io/blob/cdf8005ac1cd46cfdcda05d72a7ec8d21bbb8782/content/posts/continuous-time-modeling-of-counterfatual-outcomes.md>https://github.com/n1o/n1o.github.io/blob/cdf8005ac1cd46cfdcda05d72a7ec8d21bbb8782/content/posts/continuous-time-modeling-of-counterfatual-outcomes.md</a></li></ol></div><footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"mbarak-io"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous onload="renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}]});"></script></section></div></main><script src=/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-5WLCXX3LGJ','auto');ga('send','pageview');}</script><script>(function(f,a,t,h,o,m){a[h]=a[h]||function(){(a[h].q=a[h].q||[]).push(arguments)};o=f.createElement('script'),m=f.getElementsByTagName('script')[0];o.async=1;o.src=t;o.id='fathom-script';m.parentNode.insertBefore(o,m)})(document,window,'//analytics.example.com/tracker.js','fathom');fathom('set','siteId','ABCDE');fathom('trackPageview');</script><script async defer data-domain=example.com src=https://analytics.example.com/js/plausible.js></script><script data-goatcounter=https://code.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "token"}'></script></body></html>