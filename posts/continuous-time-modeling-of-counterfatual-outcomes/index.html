<!doctype html><html lang=en><head><title>Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations · Data, Code and Breaking Stuff
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="n1o_c0rTx"><meta name=description content="The problem it solves Link to heading Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:
If I perform a hypothetical sequence of interventions how will my time series evolve?
An example and some details Link to heading Example Link to heading As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations"><meta name=twitter:description content="The problem it solves Link to heading Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:
If I perform a hypothetical sequence of interventions how will my time series evolve?
An example and some details Link to heading Example Link to heading As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics."><meta property="og:url" content="https://n1o.github.io/posts/continuous-time-modeling-of-counterfatual-outcomes/"><meta property="og:site_name" content="Data, Code and Breaking Stuff"><meta property="og:title" content="Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations"><meta property="og:description" content="The problem it solves Link to heading Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:
If I perform a hypothetical sequence of interventions how will my time series evolve?
An example and some details Link to heading Example Link to heading As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-16T17:37:36+01:00"><meta property="article:modified_time" content="2023-01-16T17:37:36+01:00"><meta property="article:tag" content="Causality"><meta property="article:tag" content="Differential_equation"><link rel=canonical href=https://n1o.github.io/posts/continuous-time-modeling-of-counterfatual-outcomes/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.127.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Data, Code and Breaking Stuff
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/awesome-t5/>Awesome T5</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://n1o.github.io/posts/continuous-time-modeling-of-counterfatual-outcomes/>Paper overview: Continuous-Time Modeling of Counterfactual Outcomes Using Neural Controlled Differential Equations</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-01-16T17:37:36+01:00>January 16, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
6-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/causality/>Causality</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/differential_equation/>Differential_equation</a></span></div></div></header><div class=post-content><h1 id=the-problem-it-solves>The problem it solves
<a class=heading-link href=#the-problem-it-solves><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Imagine you have an irregullary sampled time series, where at various time points we perform interventions. These interventions may influence the dynamics of the timeseries. The question we want to answer is:</p><p><em>If I perform a hypothetical sequence of interventions how will my time series evolve?</em></p><h1 id=an-example-and-some-details>An example and some details
<a class=heading-link href=#an-example-and-some-details><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><h2 id=example>Example
<a class=heading-link href=#example><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>As a medical doctor in a hospital, if a patient has a high fever and is at risk of dying, a common practice is to measure their levels of C-reactive protein (CRP) to determine if they need antibiotics. If the CRP level is high, antibiotics are administered at a certain dosage. However, the effects of antibiotics may not be immediate and it may take some time before they show. In this scenario, the doctor would wait for some time and measure the patient&rsquo;s CRP levels again.</p><p>There are generally 3 outcomes that can occur in this scenario:</p><ol><li><p>The CRP level decreases after antibiotics are administered, indicating that the infection is being successfully treated.</p></li><li><p>The CRP level remains unchanged or only slightly decreases, indicating that the antibiotics may not be effective for this particular infection or the dosage may not be sufficient.</p></li><li><p>The CRP level increases, indicating that the infection may be getting worse and a different course of treatment may be needed.</p></li></ol><p>It is our decision to stick with the current treatment or change it.</p><h2 id=details>Details
<a class=heading-link href=#details><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We can visuallize the example above as:</p><p><img alt="Medical Example" src=/images/ct_cde_medical_example.jpg></p><p>At every time step we measure the CRP levels of a patient. The CRP levels not only influence the dosage and type of antibiotics prescribed, but they also serve as an indicator of the patient&rsquo;s likelihood of dying. Antibiotics are intended to lower the probability of death by reducing future CRP levels. This logic is intuitive, but there is a hidden catch: we have introduced time-dependent confounding. To understand this, let&rsquo;s start by defining time-dependent variables and time-dependent treatment.</p><h3 id=time-dependent-variables>Time-Dependent variables
<a class=heading-link href=#time-dependent-variables><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Are variables that change over time and they are repeatedly measured. In our case CRP levels are a time-dependent variable</p><h3 id=time-dependent-treatment>Time-Dependent treatment
<a class=heading-link href=#time-dependent-treatment><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Treatment (or just action) that is a response to a change in time-dependent variable. In our case this the type and dose of antibiotics.</p><h3 id=time-dependent-confounding>Time-Dependent confounding
<a class=heading-link href=#time-dependent-confounding><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>It is a confounder that is affected by the previous treatment. In our case the current dose (type) of antibiotics has an influence on future doses (types) of antibiotics. For those who have an machine learning background we can say that each treatment introduces an distribution shift.</p><h1 id=counterfactuals-confounding--and-bias>Counterfactuals, confounding and bias
<a class=heading-link href=#counterfactuals-confounding--and-bias><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>At the beggining we asked the following question:</p><p><em>If I perform a hypothetical sequence of interventions how will my time series evolve?</em></p><p>We already introduced time-dependent confounding, so we know that each time we perform some sort of intervention it potentially can shift the distribution. In order to accurately determine the effect of a hypothetical sequence of interventions, it is crucial to take into account all past interventions and consider how each new intervention could potentially affect the distribution further.</p><p>If we want to have an unbiased counterfactual estimate we have to remove confounding (close all the back doors).</p><h1 id=treatment-effect-neural-controlled-differential-equation-tc-cde-model>Treatment Effect Neural Controlled Differential Equation (TC-CDE) Model
<a class=heading-link href=#treatment-effect-neural-controlled-differential-equation-tc-cde-model><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>The main idea is to use time-dependent variables and treatments to fit a neural controlled differential equation (NCDE). An NCDE is a type of differential equation where the vector field is represented by a neural network. The solution to the equation is not only determined by its initial conditions, but also by subsequent observations.</p><p>For example, in the context of inflammation, we can view inflammation as a latent process that evolves over time due to the immune system or medication. CRP levels are realizations of this latent process. Modeling this process can be difficult, but the TC-CDE model addresses this by expressing the latent process as a solution to an NCDE.</p><p>However, for counterfactual estimation, modeling the latent process as an NCDE is not sufficient. To achieve an unbiased counterfactual estimate, we need to ensure that the latent process is not predictive of the treatment that will be administered. Additionally, we need to ensure that administering a treatment at time t will not change the latent value at time t, but only influence its future latent dynamics.</p><h2 id=a-bit-of-math>A bit of Math
<a class=heading-link href=#a-bit-of-math><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I always try to avoid using equations, but I don&rsquo;t always succeed. For those who are more familiar with machine learning and haven&rsquo;t seen differential equations in a while (or ever), the strange integral can be viewed as the temporal evolution of some state. The dynamics of the evolution are governed by a differential equation.</p><h3 id=latent-path>Latent Path
<a class=heading-link href=#latent-path><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>To get the latent path we first have to define the initial state:</p><p>$$Z_{t0} = g_{\eta}(X_{t0},A_{t0}, Y_{t0})$$</p><ul><li>$g_{\theta}$ is a neural network that takes the initial covariates $X_{t0}$, treatment assignment $A_{t0}$ and observed outcome $T_{t0}$ and produces the initial latent space embedding $Z_{t0}$</li></ul><p>Next we define our evolution of the initial state:</p><p>$$Z_t = S_{t0} + \int_{t_0}^t f_{\theta}(Z_s) \frac{d[S_s, A_s, Y_s]}{ds}ds $$</p><p>for $t \in (t_0, t]$</p><ul><li>$Z$ is a response that is a solution to NCDE</li><li>$f_{\theta}$ is the latent vector field parametrized by a neural network</li></ul><h3 id=objective-function>Objective function
<a class=heading-link href=#objective-function><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>To mitigate confounding bias we have to make sure that the latent path is not predictive of future treatments to achieve this we introduce 2 neural networks:</p><ol><li><p>$h_v: R^l \rightarrow R^d$ used to predict the outcome $\hat{y}_s = h_v(Z_s)$</p></li><li><p>$h_a: R^l \rightarrow [0,1]$ used to predict the treatment $\hat{p}<em>s = \hat{p}(a_s = 1) = h</em>{a}(Z_s)$</p></li></ol><p>If there are k>1 observations in the timewindow $[t,t&rsquo;]$ with observation times $(t_1, \cdots, t_k)$ our loss function is defined as</p><p>$$L = \frac{1}{n}\sum_{i=1}^n L_i^{(y)} - \mu L_i^{(a)} $$</p><ul><li>$L^{(y)} = \frac{1}{k} (y_{t_j} - \hat{y}_{t_j})^2$ this is the sequare mean of outcome prediction</li><li>$L^{(a)} = - \frac{1}{k} \sum_{j=1}^k a_{t_j} \log(\hat{p}<em>{t_j}) + (1-a_j)\log (1 - \hat{p}</em>{t_j})$ this is the cross entropy of treatment predictions</li></ul><p>Since there is a substraction before $\mu$ we essentially maximize the cross entropy ensuring that $z_t$ is not predictive of the treatment assignment $A_t$. This leads to balancing representations removing bias form time-dependent confounders allowing reliable counterfactual estimation where $\mu$ controlls the tradeoff between treatment and outcome predictions.</p><h3 id=hypothetical-path>Hypothetical path
<a class=heading-link href=#hypothetical-path><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Our initial goal was to evaluate the effect of some hypothetical treatment schedule. Because of this we need to go from $t$ to some future $t&rsquo;$:</p><p>$$Z_{t&rsquo;} = Z_t = \int_{t}^{t&rsquo;}f_{\theta}(Z_s)\frac{dA_s}{ds}ds $$</p><ul><li>$Z_t$ is the encoded latent state of a patient up to time t</li><li>$A_s$ is the hypothetical treatment schedule $t &lt; s &lt; t'$</li></ul><p>To get the predicted outcome we use our neural network trained before</p><p>$$\hat{y}<em>{t&rsquo;} = h_v(Z</em>{t&rsquo;})$$</p><h1 id=summary>Summary
<a class=heading-link href=#summary><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Being able to generate unbiased estimates of some outcome value given hypothetical treatment schedules (or just some sort of actions) is a powerful tool. And not requiring an fixed schedule for these actions makes it also very versatile. And I look forward for extensions on these method.</p><h1 id=disclaimer>Disclaimer
<a class=heading-link href=#disclaimer><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>I did read the original paper, and look at the code that was supplied with it. I did write this article on my own, however since I am not a native speaker, I did use ChatGPT for proof reading and improving my writing. If you are really interested how the original was worded. I will provide a link below.</p><h1 id=sources>Sources
<a class=heading-link href=#sources><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><ol><li><a href=https://github.com/seedatnabeel/TE-CDE>https://github.com/seedatnabeel/TE-CDE</a></li><li><a href=https://arxiv.org/abs/2206.08311>https://arxiv.org/abs/2206.08311</a></li><li>Pre ChatGPT: <a href=https://github.com/n1o/n1o.github.io/blob/cdf8005ac1cd46cfdcda05d72a7ec8d21bbb8782/content/posts/continuous-time-modeling-of-counterfatual-outcomes.md>https://github.com/n1o/n1o.github.io/blob/cdf8005ac1cd46cfdcda05d72a7ec8d21bbb8782/content/posts/continuous-time-modeling-of-counterfatual-outcomes.md</a></li></ol></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mbarak-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2020 -
2024
n1o_c0rTx
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5WLCXX3LGJ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5WLCXX3LGJ")}</script></body></html>