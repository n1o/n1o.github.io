<!doctype html><html lang=en><head><title>Nixos for Hobby Project · Data, Code and Breaking Stuff
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="n1o"><meta name=description content="Lately, I&rsquo;ve embarked on a side project: CodeBreakers. It&rsquo;s nothing too fancy, just a website where I plan to release videos and articles about my latest passions—Reverse Engineering and Binary Exploitation.
Creating a website isn&rsquo;t all that complex, and I&rsquo;ve done it a couple of times before. The main challenge was deciding where and how to host it. Initially, I considered using Fly ((which is a fantastic PaaS product with many built-in features), but ultimately, I opted for Hetzner and rented a virtual server."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nixos for Hobby Project"><meta name=twitter:description content="Lately, I&rsquo;ve embarked on a side project: CodeBreakers. It&rsquo;s nothing too fancy, just a website where I plan to release videos and articles about my latest passions—Reverse Engineering and Binary Exploitation.
Creating a website isn&rsquo;t all that complex, and I&rsquo;ve done it a couple of times before. The main challenge was deciding where and how to host it. Initially, I considered using Fly ((which is a fantastic PaaS product with many built-in features), but ultimately, I opted for Hetzner and rented a virtual server."><meta property="og:title" content="Nixos for Hobby Project"><meta property="og:description" content="Lately, I&rsquo;ve embarked on a side project: CodeBreakers. It&rsquo;s nothing too fancy, just a website where I plan to release videos and articles about my latest passions—Reverse Engineering and Binary Exploitation.
Creating a website isn&rsquo;t all that complex, and I&rsquo;ve done it a couple of times before. The main challenge was deciding where and how to host it. Initially, I considered using Fly ((which is a fantastic PaaS product with many built-in features), but ultimately, I opted for Hetzner and rented a virtual server."><meta property="og:type" content="article"><meta property="og:url" content="https://n1o.github.io/posts/nixos-for-hobby-project/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-13T13:09:10+02:00"><meta property="article:modified_time" content="2023-09-13T13:09:10+02:00"><link rel=canonical href=https://n1o.github.io/posts/nixos-for-hobby-project/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.124.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Data, Code and Breaking Stuff
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://n1o.github.io/posts/nixos-for-hobby-project/>Nixos for Hobby Project</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-09-13T13:09:10+02:00>September 13, 2023
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/nixos/>NixOS</a></span></div></div></header><div class=post-content><p>Lately, I&rsquo;ve embarked on a side project: <a href=https://codebreakers.re/courses/>CodeBreakers</a>. It&rsquo;s nothing too fancy, just a website where I plan to release videos and articles about my latest passions—Reverse Engineering and Binary Exploitation.</p><p>Creating a website isn&rsquo;t all that complex, and I&rsquo;ve done it a couple of times before. The main challenge was deciding where and how to host it. Initially, I considered using <a href=https://fly.io/>Fly</a> ((which is a fantastic PaaS product with many built-in features), but ultimately, I opted for <a href=hetzner.com>Hetzner</a> and rented a virtual server.</p><p>Managing a virtual server is definitely a more hands-on solution (and it comes with its fair share of challenges), but it provided me with the opportunity to explore the idea of using <a href=https://nixos.org/>NixOS</a> on my server.</p><h1 id=nixos>Nixos
<a class=heading-link href=#nixos><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>I used NixOS as my primary OS for around two years, and I must admit, it had its moments of difficulty. For those unfamiliar with it, NixOS is a unique Linux distribution built around the <a href=https://nix.dev/tutorials/first-steps/nix-language>Nix</a>programming language. What sets it apart is that your entire operating system configuration is expressed as code.</p><p>You might ask:</p><p>&ldquo;Isn&rsquo;t having the operating system as code similar to tools like Ansible, Puppet, or SaltStack?&rdquo;</p><p>Well, it depends. The technologies mentioned above are more sophisticated and offer a broader range of features. With NixOS, the configuration is more akin to something like Terraform. Essentially, you have a set of features that you can enable and configure (with support for custom modules, so the sky&rsquo;s the limit).</p><h1 id=my-setup>My Setup
<a class=heading-link href=#my-setup><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Now, with a server running NixOS (if you don&rsquo;t have it yet, you can <a href=https://github.com/elitak/nixos-infect>Infect</a>)), here&rsquo;s what I want to achieve:</p><ol><li>Ngnix</li><li>Postgresql</li><li>Django</li></ol><p>At Hetzner, I acquired a virtual server for just under 6 Euros, equipped with 2 vCPUs, 4 GB of RAM, and a fixed IP. This is more than sufficient to run everything I need on a single machine. Plus, if I require additional resources, I can efficiently scale vertically. Running all my services on a single machine allows them to communicate through Unix sockets, and the only open ports I need are:</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>networking.firewall <span style=color:red>=</span> {
</span></span><span style=display:flex><span>    enable = true;
</span></span><span style=display:flex><span>    allowedTCPPorts = [<span style=color:#ff0;font-weight:700>22</span> <span style=color:#ff0;font-weight:700>80</span> <span style=color:#ff0;font-weight:700>443</span>];
</span></span><span style=display:flex><span>  };
</span></span></code></pre></div><p>NixOS, by default, prioritizes security. Consequently, any ports you wish to open must be explicitly defined.</p><h2 id=ngnix>Ngnix
<a class=heading-link href=#ngnix><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I use Let&rsquo;s Encrypt certificates to keep costs as low as possible.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>services.nginx <span style=color:red>=</span> {
</span></span><span style=display:flex><span>    enable = true;
</span></span><span style=display:flex><span>    virtualHosts = {
</span></span><span style=display:flex><span>	    <span style=color:#0ff;font-weight:700>&#34;codebreakers.re&#34;</span> = {
</span></span><span style=display:flex><span>	        addSSL = true;
</span></span><span style=display:flex><span>	        enableACME = true;
</span></span><span style=display:flex><span>	        locations.<span style=color:#0ff;font-weight:700>&#34;/.well-known/acme-challenge&#34;</span> = {
</span></span><span style=display:flex><span>	        root = <span style=color:#0ff;font-weight:700>&#34;/var/lib/acme/.challenges&#34;</span>;
</span></span><span style=display:flex><span>	        };
</span></span><span style=display:flex><span>	    locations.<span style=color:#0ff;font-weight:700>&#34;/static/&#34;</span> = {
</span></span><span style=display:flex><span>	    	alias = <span style=color:#0ff;font-weight:700>&#34;/www/codebreakers/staticfiles/&#34;</span>;
</span></span><span style=display:flex><span>            extraConfig  = <span style=color:#0ff;font-weight:700>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>            expires 1h;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>            add_header Cache-Control &#34;public&#34;;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>            &#39;&#39;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>	    locations.<span style=color:#0ff;font-weight:700>&#34;/&#34;</span> = {
</span></span><span style=display:flex><span>	    	proxyPass = <span style=color:#0ff;font-weight:700>&#34;http://unix:/run/gunicorn.sock&#34;</span>;
</span></span><span style=display:flex><span>	    };
</span></span><span style=display:flex><span>	  };
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>users.users.nginx.extraGroups <span style=color:red>=</span> [ <span style=color:#0ff;font-weight:700>&#34;acme&#34;</span> ];
</span></span><span style=display:flex><span>security.acme <span style=color:red>=</span> {
</span></span><span style=display:flex><span>    acceptTerms = true;
</span></span><span style=display:flex><span>    email = <span style=color:#0ff;font-weight:700>&#34;my@email.com&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Under the hood, there is an <code>nginx</code> Linux user created, under which Nginx runs as a systemd daemon. Instead of having an <code>nginx.conf</code> file, our configuration is inlined.</p><h2 id=postgresql>Postgresql
<a class=heading-link href=#postgresql><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>services.postgresql <span style=color:red>=</span> {
</span></span><span style=display:flex><span>  enable = true;
</span></span><span style=display:flex><span>  package = pkgs.postgresql_15;
</span></span><span style=display:flex><span>  ensureDatabases = [ <span style=color:#0ff;font-weight:700>&#34;codebreakers&#34;</span> ];
</span></span><span style=display:flex><span>  authentication = pkgs.lib.mkOverride <span style=color:#ff0;font-weight:700>10</span> <span style=color:#0ff;font-weight:700>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>    local all       all     trust
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  initialScript = pkgs.writeText <span style=color:#0ff;font-weight:700>&#34;backend-initScript&#34;</span> <span style=color:#0ff;font-weight:700>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>    CREATE USER codebreakers WITH PASSWORD &#39;password&#39;;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>    GRANT ALL PRIVILEGES ON DATABASE codebreakers TO codebreakers;
</span></span></span><span style=display:flex><span><span style=color:#0ff;font-weight:700>  &#39;&#39;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Similarly to Nginx, under the hood, a <code>postgres</code> user is created. By default, this user doesn&rsquo;t open the typical <code>5432</code> port or allow TCP connections. However, we won&rsquo;t need that, as we can communicate with it through a Unix socket located at <code>/var/run/postgresql/.s.PGSQL.5432</code>.</p><h2 id=django>Django
<a class=heading-link href=#django><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>This was one of my pain points in the past. While working on Python projects on NixOS (This is especially true if you need libraries like Pytorch), the experience was anything but friendly. Consequently, I eventually decided to run my application within a Docker container (technically using <a href=https://podman.io/>Podman</a>).</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>virtualisation.oci-containers.containers = {
</span></span><span style=display:flex><span>   djnago = {
</span></span><span style=display:flex><span>	image = <span style=color:#0ff;font-weight:700>&#34;ghcr.io/n1o/codebreakers-re:$TAG&#34;</span>;
</span></span><span style=display:flex><span>	entrypoint = <span style=color:#0ff;font-weight:700>&#34;poetry&#34;</span>;
</span></span><span style=display:flex><span>	cmd = [
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;run&#34;</span> 
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;gunicorn&#34;</span> 
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;codebreakers.wsgi&#34;</span> 
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;-w&#34;</span> <span style=color:#0ff;font-weight:700>&#34;2&#34;</span> 
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;-b&#34;</span> <span style=color:#0ff;font-weight:700>&#34;unix:/run/gunicorn.sock&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;--access-logfile&#34;</span> <span style=color:#0ff;font-weight:700>&#34;&#39;-&#39;&#34;</span> 
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;--error-logfile&#34;</span> <span style=color:#0ff;font-weight:700>&#34;&#39;-&#39; &#34;</span>
</span></span><span style=display:flex><span>		];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	login = {
</span></span><span style=display:flex><span>		username = <span style=color:#0ff;font-weight:700>&#34;n1o&#34;</span>;
</span></span><span style=display:flex><span>		passwordFile = <span style=color:#0ff;font-weight:700>&#34;/etc/nixos/github-container-password.txt&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>    user = <span style=color:#0ff;font-weight:700>&#34;django&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	volumes = [
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;/var/run/postgresql/:/var/run/postgresql/&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#0ff;font-weight:700>&#34;/run/:/run/&#34;</span>
</span></span><span style=display:flex><span>	];
</span></span><span style=display:flex><span>   };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This tells Nixos to run <code>django</code> container as a systemd daemon.</p><h1 id=release-or-cicd>Release or CI/CD
<a class=heading-link href=#release-or-cicd><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>I store all my code in a single GitHub repository. I have a GitHub action that runs every time I create a new Git tag. This action collects static Django assets, builds my Docker image, which is then pushed to GitHub&rsquo;s Container Repository. It replaces the <code>$TAG</code> placeholder with the appropriate value and copies the NixOS configuration files to the server through SCP. Finally, on the server, it executes <code>nixos-rebuild switch</code> as the last step. And the new version is live. And if the switch fails than we stay at the version as before.</p><h1 id=is-nixos-for-your>Is NixOS for your
<a class=heading-link href=#is-nixos-for-your><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>Yes it is! Ok so it has some gotchas but if I compare to tools I used before this is a definite improvement.</p><h1 id=disclaimer>Disclaimer
<a class=heading-link href=#disclaimer><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><p>I did write this article, but since my writing is far from being perfect I used Chat GPT to improve my writing.</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mbarak-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2020 -
2024
n1o
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5WLCXX3LGJ"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5WLCXX3LGJ",{anonymize_ip:!1})}</script></body></html>